<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FairShare - Expense Splitter</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Brand Colors */
            --primary: #1cc29f; /* Distinctive Green/Teal */
            --primary-dark: #159c7f;
            --primary-light: #e0f7fa;
            --danger: #ff6565;
            --danger-dark: #e04f4f;
            --text-main: #333333;
            --text-light: #898989;
            --bg-app: #fcfcfc;
            --bg-surface: #ffffff;
            --border: #eeeeee;
            
            /* Spacing & Shape */
            --radius-lg: 16px;
            --radius-md: 12px;
            --radius-sm: 8px;
            --shadow-soft: 0 4px 20px rgba(0,0,0,0.05);
            --shadow-float: 0 8px 24px rgba(28, 194, 159, 0.3);
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-app);
            color: var(--text-main);
            margin: 0;
            padding-bottom: 100px; /* Space for FAB */
        }

        /* --- Header --- */
        header {
            background: var(--bg-surface);
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .logo {
            font-weight: 700;
            font-size: 1.25rem;
            color: var(--primary);
            letter-spacing: -0.5px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .btn-icon-header {
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            color: var(--text-light);
            padding: 4px;
            transition: color 0.2s;
        }
        .btn-icon-header:hover {
            color: var(--primary);
        }

        /* Letter Avatar Styles */
        .user-avatar {
            width: 36px;
            height: 36px;
            background: var(--primary-light);
            color: var(--primary-dark);
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.1rem;
            text-transform: uppercase;
            user-select: none;
        }

        /* --- Main Layout --- */
        main {
            padding: 24px;
            max-width: 600px;
            margin: 0 auto;
        }

        /* --- Balance Card --- */
        .balance-card {
            background: var(--bg-surface);
            border-radius: var(--radius-lg);
            padding: 24px;
            box-shadow: var(--shadow-soft);
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 32px;
            border: 1px solid var(--border);
        }

        .balance-col {
            flex: 1;
            text-align: center;
        }

        .balance-col label {
            font-size: 0.65rem; /* Slightly smaller to fit 3 cols */
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-light);
            font-weight: 600;
            display: block;
            margin-bottom: 4px;
            white-space: nowrap; /* Prevent wrapping if possible, or allow if needed */
        }
        
        @media (max-width: 400px) {
            .balance-col label {
                white-space: normal;
                font-size: 0.6rem;
            }
        }

        .balance-col .amount {
            font-size: 1.25rem;
            font-weight: 700;
        }

        .divider {
            width: 1px;
            height: 40px;
            background-color: var(--border);
            margin: 0 12px;
        }

        .text-green { color: var(--primary); }
        .text-red { color: var(--danger); }
        .text-blue { color: #3b82f6; } /* New Blue for Settlements */
        .text-gray { color: var(--text-light); }

        /* --- Section Headers --- */
        h2 {
            font-size: 1rem;
            color: var(--text-light);
            margin-bottom: 16px;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        /* Action Links */
        .action-link {
            font-size: 0.85rem;
            color: white;
            background: var(--primary);
            text-decoration: none;
            cursor: pointer;
            padding: 6px 14px;
            border-radius: 20px;
            transition: background 0.2s, transform 0.1s;
            font-weight: 600;
            box-shadow: 0 2px 4px rgba(28, 194, 159, 0.2);
        }
        
        .action-link:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
        }
        
        .action-link:active {
             transform: translateY(0);
        }

        .reset-link {
            font-size: 0.75rem;
            color: var(--text-light);
            text-decoration: underline;
            cursor: pointer;
            margin-right: auto;
        }
        
        /* Search Bar */
        .search-container {
            margin-bottom: 16px;
            position: relative;
        }
        .search-input {
            width: 100%;
            padding: 10px 12px 10px 36px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 0.9rem;
            background: #fff;
        }
        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1rem;
            color: var(--text-light);
        }

        /* --- Lists --- */
        .list-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 32px;
        }
        
        /* Accordion Group Styles */
        .group-block {
            background: var(--bg-surface);
            border-radius: var(--radius-md);
            overflow: hidden;
            border: 1px solid transparent;
            transition: all 0.2s;
        }
        
        .group-block.expanded {
            border-color: var(--border);
            box-shadow: var(--shadow-soft);
        }
        
        .group-block.archived {
            opacity: 0.7;
            background: #f9f9f9;
            border: 1px dashed var(--border);
        }

        .group-header {
            font-size: 0.85rem;
            text-transform: uppercase;
            color: var(--text-main);
            letter-spacing: 0.5px;
            font-weight: 700;
            padding: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            background: var(--bg-surface);
            user-select: none;
        }
        
        .group-header:hover {
            background: #fafafa;
        }
        
        .group-header-left {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .group-chevron {
            font-size: 1.2rem;
            color: var(--text-light);
            transition: transform 0.3s;
            line-height: 1;
        }
        
        .group-block.expanded .group-chevron {
            transform: rotate(90deg);
            color: var(--primary);
        }
        
        .group-content {
            display: none; /* Hidden by default */
            padding: 0 16px 16px 16px;
        }
        
        .group-block.expanded .group-content {
            display: flex;
            flex-direction: column;
            gap: 8px;
            animation: slideDown 0.2s ease-out;
        }
        
        @keyframes slideDown {
            from { transform: translateY(-10%); }
            to { transform: translateY(0); }
        }

        .group-actions {
            display: flex;
            gap: 8px;
        }

        /* Icons */
        .btn-icon-group {
            background: #f5f5f5;
            border: none;
            font-size: 1.2rem;
            line-height: 1;
            cursor: pointer;
            padding: 6px;
            border-radius: 8px;
            opacity: 1;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
        }
        
        .btn-icon-group:hover {
            background: #e0e0e0;
            transform: translateY(-1px);
            filter: brightness(0.95);
        }
        
        /* Specific colors for icons */
        .btn-icon-group.settle { color: #10b981; background: #d1fae5; } /* Green/Teal */
        .btn-icon-group.breakdown { color: #3b82f6; background: #dbeafe; } /* Blue */
        .btn-icon-group.summary { color: #8b5cf6; background: #ede9fe; } /* Purple */
        .btn-icon-group.export { color: #f59e0b; background: #fef3c7; } /* Orange/Yellow */
        .btn-icon-group.archive { color: #6b7280; background: #e5e7eb; } /* Gray */
        .btn-icon-group.delete { color: #ef4444; background: #fee2e2; } /* Red */

        /* List Item (Fixed Layout) */
        .list-item {
            background: #fcfcfc; 
            padding: 12px 16px;
            border-radius: var(--radius-sm);
            display: flex; 
            align-items: center;
            justify-content: space-between;
            border: 1px solid var(--border);
            gap: 12px;
        }

        .item-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .icon-box {
            width: 40px;
            height: 40px;
            background: #f0fdf9;
            color: var(--primary);
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .item-details h3 {
            margin: 0;
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--text-main);
        }

        .item-details p {
            margin: 4px 0 0 0;
            font-size: 0.8rem;
            color: var(--text-light);
        }

        .item-right {
            text-align: right;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 4px;
        }

        .item-right .status {
            font-size: 0.7rem;
            display: block;
            color: var(--text-light);
        }

        .item-right .value {
            font-weight: 700;
            font-size: 0.95rem;
        }

        /* Settlement Item Styles */
        .list-item.settlement {
            background: #f8fcfb;
            border-left: 4px solid var(--primary);
        }
        .list-item.settlement .icon-box {
            background: var(--primary);
            color: white;
        }
        
        /* Edit Button in List Item */
        .btn-edit-activity {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-light);
            border-radius: 50%;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            margin-left: 12px;
            font-size: 0.8rem;
            transition: all 0.2s;
        }

        .btn-edit-activity:hover {
            border-color: var(--primary);
            color: var(--primary);
            background: #f0fdf9;
        }
        
        /* Friend Delete Button */
        .btn-delete-friend {
            background: transparent;
            border: none;
            color: #e0e0e0;
            font-size: 1.5rem;
            line-height: 1;
            margin-left: 16px;
            cursor: pointer;
            padding: 0;
            display: flex;
            align-items: center;
            transition: color 0.2s;
        }
        .btn-delete-friend:hover {
            color: var(--danger);
        }

        /* --- FAB (Floating Action Button) --- */
        .fab {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 60px;
            height: 60px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            border: none;
            box-shadow: var(--shadow-float);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            transition: transform 0.2s, background 0.2s;
            z-index: 100;
        }

        .fab:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        /* --- Modal --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.4);
            backdrop-filter: blur(4px);
            z-index: 200;
            display: none; /* Hidden by default */
            align-items: flex-end; /* Sheet style on mobile */
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: white;
            width: 100%;
            max-width: 500px;
            border-radius: 24px 24px 0 0; /* Top rounded corners */
            padding: 24px;
            animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
            max-height: 90vh;
            overflow-y: auto;
        }

        @media (min-width: 500px) {
            .modal-overlay {
                align-items: center;
            }
            .modal-content {
                border-radius: var(--radius-lg);
                margin: 20px;
            }
        }

        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 1.25rem;
        }

        .btn-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--text-light);
            cursor: pointer;
            padding: 4px;
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }
        
        .modal-text {
            color: var(--text-main);
            line-height: 1.5;
            margin-bottom: 10px;
        }
        
        .warning-text {
            color: var(--danger);
            font-weight: 600;
            font-size: 0.9rem;
            background: #fff0f0;
            padding: 12px;
            border-radius: 8px;
            margin-top: 10px;
        }
        
        /* Summary Debt Line */
        .debt-line {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
        }
        .debt-line:last-child {
            border-bottom: none;
        }
        .debt-part {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            font-weight: 500;
        }
        .debt-arrow {
            color: var(--text-light);
            font-size: 0.8rem;
            margin: 0 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .debt-amount {
            font-weight: 700;
            color: var(--primary);
        }
        .btn-settle-small {
            background: white;
            border: 1px solid var(--primary);
            color: var(--primary);
            font-size: 0.7rem;
            padding: 2px 8px;
            border-radius: 12px;
            cursor: pointer;
            margin-top: 4px;
        }
        .btn-settle-small:hover {
            background: var(--primary);
            color: white;
        }
        
        /* Breakdown List */
        .breakdown-section {
            margin-bottom: 20px;
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
            background: white;
        }
        .breakdown-user {
            background: #f9f9f9;
            padding: 12px 16px;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
        }
        .breakdown-columns {
            display: flex;
            flex-direction: column;
        }
        .breakdown-col {
            padding: 0;
        }
        .breakdown-col-header {
            padding: 8px 16px;
            font-size: 0.75rem;
            text-transform: uppercase;
            font-weight: 700;
            background: #fcfcfc;
            border-bottom: 1px solid var(--border);
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
        }
        .breakdown-col-header.paid { color: var(--primary); }
        .breakdown-col-header.split { color: #e67e22; border-top: 1px solid var(--border); }
        
        .breakdown-item {
            padding: 10px 16px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            color: var(--text-main);
        }
        .breakdown-item:last-child { border-bottom: none; }
        .breakdown-item span.date {
            font-size: 0.75rem;
            margin-right: 8px;
            color: var(--text-light);
            min-width: 50px;
            display: inline-block;
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 0.85rem;
            color: var(--text-light);
            margin-bottom: 8px;
            font-weight: 500;
        }

        .form-input {
            width: 100%;
            padding: 14px;
            border: 2px solid var(--border);
            border-radius: var(--radius-md);
            font-size: 1rem;
            font-family: inherit;
            transition: border-color 0.2s;
            background: white;
        }
        
        .form-input:disabled {
            background: #f5f5f5;
            color: var(--text-light);
            cursor: not-allowed;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .input-group {
            position: relative;
        }
        
        .currency-symbol {
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-light);
            font-weight: 600;
        }

        .input-with-icon {
            padding-left: 30px;
        }

        .split-options {
            display: flex;
            gap: 10px;
        }

        .split-option {
            flex: 1;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            text-align: center;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .split-option.active {
            background: #f0fdf9;
            border-color: var(--primary);
            color: var(--primary);
            font-weight: 600;
        }

        .btn-submit {
            width: 100%;
            padding: 16px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
        }

        .btn-submit:hover {
            background: var(--primary-dark);
        }

        .btn-secondary {
            width: 100%;
            padding: 16px;
            background: #f5f5f5;
            color: var(--text-main);
            border: none;
            border-radius: var(--radius-md);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
        }
        
        .btn-danger-action {
            width: 100%;
            padding: 16px;
            background: var(--danger);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
        }
        
        .btn-danger-action:hover {
            background: var(--danger-dark);
        }

        /* --- Multi-Select Chips & Inputs --- */
        .chips-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 12px;
        }

        .chip {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 12px;
            background: #fcfcfc;
            border: 1px solid var(--border);
            border-radius: 12px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
        }

        /* Standard Equal Split Selected State */
        .chip.selectable.selected {
            background: #e8fcf7;
            border-color: var(--primary);
            color: var(--primary-dark);
        }

        /* For non-selectable modes (Shares/Percent/Amount) */
        .chip.input-mode {
            cursor: default;
            background: white;
        }

        .chip-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chip-right {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .chip input[type="checkbox"] {
            display: none;
        }
        
        /* Split Input (Shares/Percent/Amount) */
        .split-input-val {
            width: 70px;
            padding: 6px;
            border: 1px solid var(--border);
            border-radius: 6px;
            text-align: right;
            font-size: 0.9rem;
        }
        
        .split-input-label {
            font-size: 0.8rem;
            color: var(--text-light);
            min-width: 16px;
        }
        
        /* Share Counter Styles (NEW) */
        .share-counter-container {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .share-btn {
            background: #f0f0f0;
            border: 1px solid var(--border);
            border-radius: 6px;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-weight: 600;
            font-size: 1.1rem;
            user-select: none;
            transition: background 0.1s;
        }

        .share-btn:hover {
            background: #e0e0e0;
        }

        /* Hide number input arrows (Chrome/Safari/Edge/Opera) */
        .split-input-val::-webkit-outer-spin-button,
        .split-input-val::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        /* Hide number input arrows (Firefox) */
        .split-input-val[type=number] {
            -moz-appearance: textfield;
        }
        /* End of Share Counter Styles */

        /* Letter Avatar for Chips */
        .chip-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--primary-light);
            color: var(--primary-dark);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            user-select: none;
        }
        
        /* Split Tabs */
        .split-tabs {
            display: flex;
            background: #f5f5f5;
            padding: 4px;
            border-radius: 10px;
            margin-bottom: 8px;
        }
        
        .split-tab {
            flex: 1;
            text-align: center;
            padding: 8px;
            font-size: 0.85rem;
            border-radius: 8px;
            cursor: pointer;
            color: var(--text-light);
            font-weight: 500;
        }
        
        .split-tab.active {
            background: white;
            color: var(--text-main);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            font-weight: 600;
        }

        /* --- Multi-Payer Inputs --- */
        .multi-payer-list {
            display: none; /* Hidden by default */
            background: #f9f9f9;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid var(--border);
            margin-top: 8px;
        }

        .multi-payer-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        
        .multi-payer-item:last-child {
            margin-bottom: 0;
        }

        .multi-payer-label {
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .multi-payer-input {
            width: 80px;
            padding: 6px;
            border: 1px solid var(--border);
            border-radius: 4px;
            text-align: right;
        }
        
        .multi-payer-remaining {
            text-align: right;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-light);
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px dashed var(--border);
        }
        .multi-payer-remaining.error {
            color: var(--danger);
        }
        .multi-payer-remaining.success {
            color: var(--primary);
        }
        
        /* Tip Calculator specific styles */
        .tip-calculator-body {
             padding-top: 10px;
        }
        .tip-options {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }
        .tip-options .chip.selectable {
            padding: 8px 16px;
            background: #f0fdf9;
            border-color: transparent;
            color: var(--primary-dark);
        }
        .tip-options .chip.selectable.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary-dark);
        }
        .tip-results {
            background: #fafafa;
            padding: 15px;
            border-radius: 12px;
            border: 1px solid var(--border);
            margin-top: 20px;
        }
        .tip-result-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.9rem;
            color: var(--text-light);
        }
        .tip-result-row:last-child { margin-bottom: 0; }
        .tip-result-row.total {
            border-top: 1px solid var(--border);
            margin-top: 8px;
            padding-top: 8px;
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--text-main);
        }
        .tip-value {
            font-weight: 600;
            color: var(--text-main);
        }
        .tip-result-row.total .tip-value {
            color: var(--primary);
        }
        
        /* Settings Toggle */
        .toggle-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 10px;
            padding: 12px;
            background: #f9f9f9;
            border-radius: 8px;
        }
        .toggle-label {
            font-size: 0.9rem;
            font-weight: 500;
        }

        /* Utility */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-light);
            font-size: 0.9rem;
            background: var(--bg-surface);
            border-radius: var(--radius-md);
            border: 1px dashed var(--border);
        }
        
        optgroup {
            font-weight: 700;
            color: var(--primary);
        }
    </style>
</head>
<body>

    <header>
        <div class="logo">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <rect x="2" y="4" width="20" height="16" rx="4" stroke="currentColor" stroke-width="2"/>
                <path d="M12 8V16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                <path d="M8 12H16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
            FairShare
        </div>
        <div class="header-right">
            <button class="btn-icon-header" onclick="openMoreAppsModal()" title="More Apps">‚ñ¶</button>
            <button class="btn-icon-header" onclick="openTipModal()" title="Tip Calculator">üßÆ</button>
            <button class="btn-icon-header" onclick="openSettingsModal()" title="Settings">‚öôÔ∏è</button>
            <div class="user-avatar">
                A
            </div>
        </div>
    </header>

    <main>
        <!-- Dashboard Summary -->
        <section class="balance-card">
            <div class="balance-col">
                <label>Total Group Debt</label>
                <div class="amount text-red" id="total-owe">$0.00</div>
            </div>
            <div class="divider"></div>
            <div class="balance-col">
                <label>Total to be Settled</label>
                <div class="amount text-green" id="total-owed">$0.00</div>
            </div>
        </section>

        <!-- Friends List (Accordion) -->
        <section>
            <h2>
                <span onclick="openResetModal()" class="reset-link">Reset Demo</span>
                <div class="header-actions">
                    <span class="action-link" onclick="openGroupModal()">+ Group</span>
                    <span class="action-link" onclick="openFriendModal()">+ Friend</span>
                </div>
            </h2>
            <div id="friends-list" class="list-container">
                <!-- Injected by JS -->
            </div>
        </section>

        <!-- Recent Activity -->
        <section>
            <h2 id="activity-header">Recent Activity</h2>
            <!-- Search Bar -->
            <div class="search-container">
                <span class="search-icon">üîç</span>
                <input type="text" id="search-input" class="search-input" placeholder="Search expenses, people..." oninput="renderActivity()">
            </div>
            <div id="activity-list" class="list-container">
                <!-- Injected by JS -->
            </div>
        </section>
    </main>

    <!-- FAB -->
    <button class="fab" onclick="openExpenseModal()">
        +
    </button>

    <!-- Add/Edit Expense Modal -->
    <div id="expense-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="expense-modal-title">Add expense</h3>
                <button class="btn-close" onclick="closeModal('expense-modal')">&times;</button>
            </div>
            
            <form id="expense-form">
                <!-- 1. Select Group Context -->
                <div class="form-group">
                    <label class="form-label">Group</label>
                    <select id="expense-group-select" class="form-input" onchange="updateExpenseParticipants()">
                        <!-- Populated by JS -->
                    </select>
                </div>

                <!-- Date Input -->
                <div class="form-group">
                    <label class="form-label">Date</label>
                    <input type="date" id="date-input" class="form-input" required>
                </div>

                <div class="form-group">
                    <label class="form-label">Description</label>
                    <div class="input-group">
                        <input type="text" id="desc-input" class="form-input" placeholder="e.g. Dinner at Mario's" required>
                    </div>
                </div>
                
                <!-- Category (New) -->
                <div class="form-group">
                    <label class="form-label">Category (Optional)</label>
                    <select id="category-input" class="form-input">
                        <option value="">No Category</option>
                        <option value="üçî Food">üçî Food & Drink</option>
                        <option value="‚òï Coffee">‚òï Coffee Shop</option>
                        <option value="üçΩÔ∏è Restaurant">üçΩÔ∏è Restaurant</option>
                        <option value="üç∫ Bar">üç∫ Bar or Liquor</option>
                        <option value="üõí Groceries">üõí Groceries</option>
                        <option value="üè† Rent">üè† Rent/Bills</option>
                        <option value="üí° Utilities">üí° Utilities</option>
                        <option value="üè® Accommodation">üè® Accommodation</option>
                        <option value="‚úàÔ∏è Travel">‚úàÔ∏è Travel</option>
                        <option value="üöó Rental">üöó Rental Car</option>
                        <option value="üöï Taxi">üöï Taxi</option>
                        <option value="‚õΩ Transport">‚õΩ Transport</option>
                        <option value="üé¨ Entertainment">üé¨ Entertainment</option>
                        <option value="üéüÔ∏è Tickets">üéüÔ∏è Tickets/Fees</option>
                        <option value="üéØ Activities">üéØ Activities</option>
                        <option value="üéÅ Gifts">üéÅ Gifts/Donations</option>
                        <option value="üìã Supplies">üìã Supplies</option>
                        <option value="üì¶ Other">üì¶ Other</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Amount</label>
                    <div class="input-group">
                        <span class="currency-symbol currency-dynamic">$</span>
                        <input type="number" id="amount-input" class="form-input input-with-icon" placeholder="0.00" step="0.01" oninput="updateRemainingBalance(); updateSplitSummary();" required>
                    </div>
                </div>

                <!-- 2. Who Paid? -->
                <div class="form-group">
                    <label class="form-label">Who paid?</label>
                    <select id="payer-select" class="form-input" onchange="handlePayerChange()">
                        <!-- Populated by JS based on Group -->
                    </select>
                    
                    <!-- Dynamic Multi-Payer List -->
                    <div id="multi-payer-container" class="multi-payer-list">
                        <!-- Inputs injected here -->
                    </div>
                </div>

                <!-- 3. Split Options -->
                <div class="form-group">
                    <label class="form-label">Split with whom?</label>
                    
                    <!-- Split Tabs - UPDATED -->
                    <div class="split-tabs">
                        <div class="split-tab active" onclick="setSplitMethod('equal')" id="tab-equal">Equally</div>
                        <div class="split-tab" onclick="setSplitMethod('shares')" id="tab-shares">By Shares</div>
                        <div class="split-tab" onclick="setSplitMethod('percent')" id="tab-percent">By %</div>
                        <!-- NEW SPLIT TAB -->
                        <div class="split-tab" onclick="setSplitMethod('amount')" id="tab-amount">By Amount</div>
                    </div>

                    <!-- Dynamic List -->
                    <div id="split-with-container" class="chips-container">
                        <!-- Injected here -->
                    </div>
                    
                    <p style="font-size:0.75rem; color:var(--text-light); margin-top:8px; text-align:right;" id="split-summary">
                        Split evenly among selected
                    </p>
                </div>

                <button type="submit" class="btn-submit" id="btn-save-expense">Save Expense</button>
            </form>
        </div>
    </div>
    
    <!-- Settle Up Modal -->
    <div id="settle-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Settle Up</h3>
                <button class="btn-close" onclick="closeModal('settle-modal')">&times;</button>
            </div>
            
            <form id="settle-form">
                <div class="form-group">
                    <label class="form-label">Who is paying?</label>
                    <select id="settle-payer-select" class="form-input" onchange="updateSettleSuggestion()">
                         <!-- Populated by JS -->
                    </select>
                </div>
                
                <div style="text-align:center; margin: -10px 0 15px 0; font-size: 1.5rem; color: var(--text-light);">
                    &darr;
                </div>

                <div class="form-group">
                    <label class="form-label">To whom?</label>
                    <select id="settle-recipient-select" class="form-input" onchange="updateSettleSuggestion()">
                         <!-- Populated by JS -->
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Amount</label>
                    <div class="input-group">
                        <span class="currency-symbol currency-dynamic">$</span>
                        <input type="number" id="settle-amount-input" class="form-input input-with-icon" placeholder="0.00" step="0.01" required>
                    </div>
                </div>
                
                 <div class="form-group">
                    <label class="form-label">Date</label>
                    <input type="date" id="settle-date-input" class="form-input" required>
                </div>

                <button type="submit" class="btn-submit">Record Payment</button>
            </form>
        </div>
    </div>

    <!-- Summary Modal -->
    <div id="summary-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="summary-title">Debts Summary</h3>
                <button class="btn-close" onclick="closeModal('summary-modal')">&times;</button>
            </div>
            <div style="margin-bottom:16px; font-size:0.9rem; color:var(--text-light);">
                Simplified debts for least number of transactions.
            </div>
            <div id="summary-list" class="list-container">
                <!-- Injected via JS -->
            </div>
            <div class="modal-actions">
                 <button class="btn-secondary" onclick="closeModal('summary-modal')">Close</button>
            </div>
        </div>
    </div>

    <!-- Breakdown Modal -->
    <div id="breakdown-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="breakdown-title">Expense Breakdown</h3>
                <button class="btn-close" onclick="closeModal('breakdown-modal')">&times;</button>
            </div>
            <div style="margin-bottom:16px; font-size:0.9rem; color:var(--text-light);">
                List of expenses incurred (paid) by each participant.
            </div>
            <div id="breakdown-list" style="max-height: 60vh; overflow-y: auto;">
                <!-- Injected via JS -->
            </div>
            <div class="modal-actions">
                 <button class="btn-secondary" onclick="closeModal('breakdown-modal')">Close</button>
            </div>
        </div>
    </div>
    
    <!-- Tip Calculator Modal (New) -->
    <div id="tip-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Tip Calculator</h3>
                <button class="btn-close" onclick="closeModal('tip-modal')">&times;</button>
            </div>
            <div class="tip-calculator-body">
                <!-- Inputs -->
                <div class="form-group">
                    <label class="form-label">Bill Amount</label>
                    <div class="input-group">
                        <span class="currency-symbol currency-dynamic">$</span>
                        <input type="number" id="tip-bill-amount" class="form-input input-with-icon" placeholder="0.00" step="0.01" oninput="calculateTip()">
                    </div>
                </div>
                 <div class="form-group">
                    <label class="form-label">Tip Percentage</label>
                    <div class="tip-options">
                        <button class="chip selectable active" id="tip-10" onclick="setTipPct(10)">10%</button>
                        <button class="chip selectable" id="tip-15" onclick="setTipPct(15)">15%</button>
                        <button class="chip selectable" id="tip-18" onclick="setTipPct(18)">18%</button>
                        <button class="chip selectable" id="tip-20" onclick="setTipPct(20)">20%</button>
                        <input type="number" id="tip-custom-pct" placeholder="Custom %" class="form-input" style="width:100px; padding:8px;" oninput="setCustomTip()">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Split by</label>
                    <div style="display:flex; align-items:center; gap:10px;">
                        <button class="btn-icon-group" style="width:40px; height:40px;" onclick="adjustSplit(-1)">-</button>
                        <input type="number" id="tip-split-count" class="form-input" value="1" style="text-align:center; width:60px;" readonly>
                         <button class="btn-icon-group" style="width:40px; height:40px;" onclick="adjustSplit(1)">+</button>
                    </div>
                </div>
                
                <!-- Results -->
                <div class="tip-results">
                     <div class="tip-result-row">
                        <span>Tip Amount</span>
                        <span class="tip-value" id="res-tip-amount">$0.00</span>
                     </div>
                     <div class="tip-result-row total">
                        <span>Total to Pay</span>
                        <span class="tip-value" id="res-total-amount">$0.00</span>
                     </div>
                     <div class="tip-result-row">
                        <span>Per Person</span>
                        <span class="tip-value" id="res-per-person">$0.00</span>
                     </div>
                </div>
            </div>
            <div class="modal-actions">
                 <button class="btn-secondary" onclick="closeModal('tip-modal')">Close</button>
            </div>
        </div>
    </div>
    
    <!-- Settings Modal (New) -->
    <div id="settings-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Data & Settings</h3>
                <button class="btn-close" onclick="closeModal('settings-modal')">&times;</button>
            </div>
            
            <div style="display:flex; flex-direction:column; gap:16px;">
                <!-- Currency Selector -->
                <div class="form-group">
                    <label class="form-label">Currency Symbol</label>
                    <select id="currency-select" class="form-input" onchange="updateCurrencyAndSave(this.value)">
                        <option value="$">USD ($)</option>
                        <option value="‚Ç¨">EUR (‚Ç¨)</option>
                        <option value="¬£">GBP (¬£)</option>
                        <option value="‚Çπ">INR (‚Çπ)</option>
                        <option value="¬•">JPY (¬•)</option>
                    </select>
                </div>

                <!-- Show Archived Toggle -->
                <div class="toggle-container">
                    <span class="toggle-label">Show Archived Groups</span>
                    <input type="checkbox" id="show-archived-toggle" onchange="toggleShowArchived(this.checked)">
                </div>

                <div style="height:1px; background:#eee; margin:8px 0;"></div>
                
                <div>
                    <p class="modal-text" style="font-size:0.8rem;">Backup your data to a JSON file or restore from a previous backup.</p>
                </div>
                
                <button class="btn-submit" onclick="exportData()">
                    ‚¨áÔ∏è Export Data to JSON
                </button>
                
                <button class="btn-secondary" onclick="document.getElementById('import-file').click()">
                    ‚¨ÜÔ∏è Import Data from JSON
                </button>
                <input type="file" id="import-file" accept=".json" style="display:none;" onchange="initiateImport(event)">
            </div>

            <div class="modal-actions">
                 <button class="btn-secondary" onclick="closeModal('settings-modal')">Close</button>
            </div>
        </div>
    </div>

    <!-- Add Friend Modal -->
    <div id="friend-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add new friend</h3>
                <button class="btn-close" onclick="closeModal('friend-modal')">&times;</button>
            </div>
            <form id="friend-form">
                <div class="form-group">
                    <label class="form-label">Name</label>
                    <input type="text" id="friend-name-input" class="form-input" placeholder="e.g. John Doe" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Assign to Group</label>
                    <select id="group-select-assign" class="form-input">
                        <!-- Populated by JS -->
                    </select>
                </div>
                <button type="submit" class="btn-submit">Add Friend</button>
            </form>
        </div>
    </div>

    <!-- Add Group Modal -->
    <div id="group-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Create new group</h3>
                <button class="btn-close" onclick="closeModal('group-modal')">&times;</button>
            </div>
            <form id="group-form">
                <div class="form-group">
                    <label class="form-label">Group Name</label>
                    <input type="text" id="group-name-input" class="form-input" placeholder="e.g. Ski Trip 2024" required>
                </div>
                <button type="submit" class="btn-submit">Create Group</button>
            </form>
        </div>
    </div>

    <!-- Confirm Delete Modal -->
    <div id="confirm-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="confirm-title">Confirm Delete</h3>
                <button class="btn-close" onclick="closeModal('confirm-modal')">&times;</button>
            </div>
            <div id="confirm-message" class="modal-text">
                Are you sure you want to delete this group?
            </div>
            <div id="confirm-warning" class="warning-text" style="display:none;">
                <!-- Warning injected here -->
            </div>
            <div class="modal-actions">
                <button class="btn-secondary" onclick="closeModal('confirm-modal')">Cancel</button>
                <button class="btn-danger-action" id="btn-confirm-action">Delete</button>
            </div>
        </div>
    </div>

    <!-- Alert/Warning Modal -->
    <div id="alert-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Action Required</h3>
                <button class="btn-close" onclick="closeModal('alert-modal')">&times;</button>
            </div>
            <div class="modal-text">
                Please create a group first before adding friends.
            </div>
            <div class="modal-actions">
                <button class="btn-submit" onclick="redirectGroupCreation()">Create Group</button>
            </div>
        </div>
    </div>

    <!-- Reset Confirmation Modal -->
     <div id="reset-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Reset App?</h3>
                <button class="btn-close" onclick="closeModal('reset-modal')">&times;</button>
            </div>
            <div class="modal-text">
                This will erase all your current data and restore the demo data. This cannot be undone.
            </div>
            <div class="modal-actions">
                <button class="btn-secondary" onclick="closeModal('reset-modal')">Cancel</button>
                <button class="btn-danger-action" onclick="executeReset()">Reset All</button>
            </div>
        </div>
    </div>
    
    <!-- More Apps Modal -->
    <div id="more-apps-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h3>More from Developer</h3>
                <button class="btn-close" onclick="closeModal('more-apps-modal')">&times;</button>
            </div>
            <div style="display: flex; flex-direction: column; gap: 12px; margin-top: 10px;">
                <a href="https://mastercoder346.github.io/RideWise/" target="_blank" 
                   style="display: flex; align-items: center; gap: 12px; padding: 16px; background: #e8f5ff; border-radius: 12px; text-decoration: none; transition: transform 0.2s, box-shadow 0.2s;"
                   onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)';"
                   onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                    <div style="width: 40px; height: 40px; background: #3b82f6; color: white; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 1.3rem;">
                        üöó
                    </div>
                    <div>
                        <div style="font-weight: 600; color: #333; font-size: 1rem;">Ride Wise</div>
                        <div style="font-size: 0.85rem; color: #666;">Ride sharing app</div>
                    </div>
                </a>
                
                <a href="https://mastercoder346.github.io/homeinventory/" target="_blank" 
                   style="display: flex; align-items: center; gap: 12px; padding: 16px; background: #f0fdf9; border-radius: 12px; text-decoration: none; transition: transform 0.2s, box-shadow 0.2s;"
                   onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)';"
                   onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                    <div style="width: 40px; height: 40px; background: #10b981; color: white; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 1.3rem;">
                        üè†
                    </div>
                    <div>
                        <div style="font-weight: 600; color: #333; font-size: 1rem;">Home Inventory</div>
                        <div style="font-size: 0.85rem; color: #666;">Manage your home items</div>
                    </div>
                </a>
            </div>
        </div>
    </div>

    <script>
        // --- Initial Data / State ---
        let appSettings = JSON.parse(localStorage.getItem('fs_settings')) || { currency: '$', showArchived: false };
        
        const defaultGroups = [
            { id: 1, name: 'Apartment', archived: false },
            { id: 2, name: 'Trip to Cabo', archived: false }
        ];

        const defaultFriends = [
            { id: 1, name: 'Sarah', groupId: 1, avatar: 'Annie', balance: 0 }, 
            { id: 2, name: 'Mike', groupId: 1, avatar: 'Felix', balance: 0 }, 
            { id: 3, name: 'Jessica', groupId: 2, avatar: 'Sorelle', balance: 0 }
        ];

        const defaultActivities = [
            { 
                id: 101, 
                groupId: 1,
                desc: 'Uber to Airport', 
                amount: 31.00, 
                date: '2023-10-24',
                payers: [{id: 2, amount: 31.00}], 
                consumers: [{id: 1, amount: 15.50}, {id: 2, amount: 15.50}], 
                payerName: 'Mike', 
                splitMethod: 'equal',
                type: 'expense',
                category: '‚õΩ Transport'
            },
            { 
                id: 102, 
                groupId: 2, // Trip to Cabo
                desc: 'Concert Tickets', 
                amount: 48.00, 
                date: '2023-10-22',
                payers: [{id: 2, amount: 48.00}], 
                consumers: [{id: 3, amount: 48.00}], 
                payerName: 'Mike',
                splitMethod: 'equal',
                type: 'expense',
                category: 'üé¨ Entertainment'
            }
        ];

        // Load from LocalStorage or use defaults
        let groups = JSON.parse(localStorage.getItem('fs_groups')) || defaultGroups;
        let friends = JSON.parse(localStorage.getItem('fs_friends')) || defaultFriends;
        let activities = JSON.parse(localStorage.getItem('fs_activities')) || defaultActivities;

        // Save defaults to localStorage if they were just loaded
        if (!localStorage.getItem('fs_groups')) {
            localStorage.setItem('fs_groups', JSON.stringify(groups));
            localStorage.setItem('fs_friends', JSON.stringify(friends));
            localStorage.setItem('fs_activities', JSON.stringify(activities));
            localStorage.setItem('fs_settings', JSON.stringify(appSettings));
        }

        let groupToDeleteId = null;
        let friendToDeleteId = null; 
        let activityToDeleteId = null; 
        let currentSplitMethod = 'equal'; 
        let editingActivityId = null; 
        
        // Accordion State
        let expandedGroupId = null;
        if(groups.length > 0) expandedGroupId = groups[0].id;
        
        // Tip Calc State - GLOBAL TRACKER
        let currentTipPct = 10;
        
        // Data buffer for import confirmation
        let importDataBuffer = null; 


        // --- DOM Elements ---
        const friendsListEl = document.getElementById('friends-list');
        const activityListEl = document.getElementById('activity-list');
        const activityHeader = document.getElementById('activity-header');
        const totalOweEl = document.getElementById('total-owe');
        const totalOwedEl = document.getElementById('total-owed');
        const searchInput = document.getElementById('search-input');
        
        const expenseModal = document.getElementById('expense-modal');
        const friendModal = document.getElementById('friend-modal');
        const groupModal = document.getElementById('group-modal');
        const summaryModal = document.getElementById('summary-modal');
        const breakdownModal = document.getElementById('breakdown-modal');
        const settleModal = document.getElementById('settle-modal');
        const settingsModal = document.getElementById('settings-modal');
        const confirmModal = document.getElementById('confirm-modal');
        const alertModal = document.getElementById('alert-modal');
        const resetModal = document.getElementById('reset-modal');
        const tipModal = document.getElementById('tip-modal');
        const moreAppsModal = document.getElementById('more-apps-modal');
        
        const expenseForm = document.getElementById('expense-form');
        const friendForm = document.getElementById('friend-form');
        const groupForm = document.getElementById('group-form');
        const settleForm = document.getElementById('settle-form');
        
        // Expense Elements
        const expenseGroupSelect = document.getElementById('expense-group-select');
        const payerSelect = document.getElementById('payer-select');
        const splitContainer = document.getElementById('split-with-container');
        const multiPayerContainer = document.getElementById('multi-payer-container');
        const splitSummary = document.getElementById('split-summary');
        const dateInput = document.getElementById('date-input');
        const expenseModalTitle = document.getElementById('expense-modal-title');
        const btnSaveExpense = document.getElementById('btn-save-expense');
        const categoryInput = document.getElementById('category-input');

        const groupSelectAssign = document.getElementById('group-select-assign');
        const confirmWarning = document.getElementById('confirm-warning');
        const confirmTitle = document.getElementById('confirm-title');
        const confirmMessage = document.getElementById('confirm-message');
        const btnConfirmAction = document.getElementById('btn-confirm-action');
        
        const summaryList = document.getElementById('summary-list');
        const summaryTitle = document.getElementById('summary-title');
        const breakdownList = document.getElementById('breakdown-list');
        const breakdownTitle = document.getElementById('breakdown-title');
        
        const settlePayerSelect = document.getElementById('settle-payer-select');
        const settleRecipientSelect = document.getElementById('settle-recipient-select');
        const settleAmountInput = document.getElementById('settle-amount-input');
        const settleDateInput = document.getElementById('settle-date-input');

        // --- Core Functions ---

        function saveData() {
            localStorage.setItem('fs_groups', JSON.stringify(groups));
            localStorage.setItem('fs_friends', JSON.stringify(friends));
            localStorage.setItem('fs_activities', JSON.stringify(activities));
            localStorage.setItem('fs_settings', JSON.stringify(appSettings));
            render();
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
            if(modalId === 'expense-modal') {
                document.getElementById('expense-form').reset();
                document.getElementById('multi-payer-container').style.display = 'none';
                document.getElementById('amount-input').readOnly = false;
                editingActivityId = null;
                document.getElementById('expense-group-select').disabled = false;
            }
            if(modalId === 'friend-modal') document.getElementById('friend-form').reset();
            if(modalId === 'group-modal') document.getElementById('group-form').reset();
            if(modalId === 'settle-modal') document.getElementById('settle-form').reset();
            if(modalId === 'confirm-modal') importDataBuffer = null; // Clear buffer if import was cancelled
        }
        
        function openSettingsModal() { 
            // Update UI settings before opening
            document.getElementById('currency-select').value = appSettings.currency;
            document.getElementById('show-archived-toggle').checked = appSettings.showArchived;
            document.getElementById('settings-modal').classList.add('active'); 
        }
        function openResetModal() { document.getElementById('reset-modal').classList.add('active'); }
        function executeReset() { localStorage.clear(); location.reload(); }
        function openGroupModal() { document.getElementById('group-modal').classList.add('active'); }
        
        function updateDropdowns() {
            if(expenseGroupSelect) {
                const currentVal = expenseGroupSelect.value;
                const activeGroups = groups.filter(g => !g.archived);
                expenseGroupSelect.innerHTML = activeGroups.map(g => 
                    `<option value="${g.id}">${g.name}</option>`
                ).join('');
                if (currentVal && activeGroups.some(g => g.id == currentVal)) {
                    expenseGroupSelect.value = currentVal;
                } else if (activeGroups.length > 0) {
                    expenseGroupSelect.value = activeGroups[0].id;
                }
            }
            if(groupSelectAssign) {
                const activeGroups = groups.filter(g => !g.archived).sort((a, b) => b.id - a.id);
                groupSelectAssign.innerHTML = activeGroups.map(g => 
                    `<option value="${g.id}">${g.name}</option>`
                ).join('');
                 // Set default to the newest group (last in sorted list)
                if (activeGroups.length > 0) {
                    groupSelectAssign.value = activeGroups[activeGroups.length - 1].id;
                }
            }
        }

        function openFriendModal() {
            if (groups.filter(g => !g.archived).length === 0) { document.getElementById('alert-modal').classList.add('active'); return; }
            
            // 1. Populate the dropdowns first
            updateDropdowns();
            
            // 2. Set the default value (already done inside updateDropdowns now)
            
            document.getElementById('friend-modal').classList.add('active');
        }
        
        function openExpenseModal() {
            if (friends.length === 0) {
                document.getElementById('alert-modal').classList.add('active');
                return;
            }
            editingActivityId = null;
            document.getElementById('expense-modal-title').innerText = "Add expense";
            document.getElementById('btn-save-expense').innerText = "Save Expense";
            document.getElementById('expense-group-select').disabled = false;
            
            document.getElementById('expense-modal').classList.add('active');
            
            window.updateDropdowns();
            
            if (expandedGroupId) {
                 document.getElementById('expense-group-select').value = expandedGroupId;
            }
            
            currentSplitMethod = null; 
            window.setSplitMethod('equal');
            
            // Default Date to Today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('date-input').value = today;
            
            document.getElementById('desc-input').focus();
        }

        function simplifyDebts(groupFriends) {
            let debtors = groupFriends.filter(f => f.balance < -0.01).map(f => ({...f}));
            let creditors = groupFriends.filter(f => f.balance > 0.01).map(f => ({...f}));
            debtors.sort((a, b) => a.balance - b.balance); 
            creditors.sort((a, b) => b.balance - a.balance); 

            let transactions = [];
            let i = 0; let j = 0;
            while (i < debtors.length && j < creditors.length) {
                let debtor = debtors[i];
                let creditor = creditors[j];
                let amount = Math.min(Math.abs(debtor.balance), creditor.balance);
                amount = Math.round(amount * 100) / 100;

                if (amount > 0) {
                    transactions.push({ from: debtor.name, to: creditor.name, fromId: debtor.id, toId: creditor.id, amount: amount, fromAvatar: debtor.avatar, toAvatar: creditor.avatar });
                }
                debtor.balance += amount;
                creditor.balance -= amount;
                if (Math.abs(debtor.balance) < 0.01) i++;
                if (creditor.balance < 0.01) j++;
            }
            return transactions;
        }

        function openSettleModal(groupId, prefillPayerId, prefillRecipientId, prefillAmount) {
            const group = groups.find(g => g.id === groupId);
            const groupFriends = friends.filter(f => f.groupId === groupId);
            if(!group || groupFriends.length < 2) { alert("Need at least 2 people to settle."); return; }
            
            const selP = document.getElementById('settle-payer-select');
            const selR = document.getElementById('settle-recipient-select');
            const ops = groupFriends.map(f => `<option value="${f.id}">${f.name}</option>`).join('');
            selP.innerHTML = ops; selR.innerHTML = ops;
            
            if(prefillPayerId && prefillRecipientId) {
                selP.value = prefillPayerId; selR.value = prefillRecipientId;
                document.getElementById('settle-amount-input').value = prefillAmount ? parseFloat(prefillAmount).toFixed(2) : '';
            } else {
                // Suggestion logic
                const sugg = simplifyDebts(groupFriends);
                if(sugg.length>0) { selP.value=sugg[0].fromId; selR.value=sugg[0].toId; document.getElementById('settle-amount-input').value=sugg[0].amount.toFixed(2); }
                else { selP.selectedIndex=0; selR.selectedIndex=1; document.getElementById('settle-amount-input').value=''; }
            }
            document.getElementById('settle-date-input').valueAsDate = new Date();
            closeModal('summary-modal');
            document.getElementById('settle-modal').classList.add('active');
        }

        function updateSettleSuggestion() {
             const pId = parseInt(document.getElementById('settle-payer-select').value);
             const rId = parseInt(document.getElementById('settle-recipient-select').value);
             if(!pId || !rId) return;
             const payer = friends.find(f=>f.id===pId);
             if(!payer) return;
             const gFriends = friends.filter(f=>f.groupId === payer.groupId);
             const suggs = simplifyDebts(gFriends);
             const match = suggs.find(s => s.fromId === pId && s.toId === rId);
             document.getElementById('settle-amount-input').value = match ? match.amount.toFixed(2) : '';
        }

        function openSummaryModal(groupId) {
            const group = groups.find(g => g.id === groupId);
            const gFriends = friends.filter(f => f.groupId === groupId);
            if(!group) return;
            document.getElementById('summary-title').innerText = `${group.name} Summary`;
            const txs = simplifyDebts(gFriends);
            const list = document.getElementById('summary-list');
            if(txs.length === 0) list.innerHTML = '<div class="empty-state">Everyone is settled up!</div>';
            else {
                list.innerHTML = txs.map(t => `
                    <div class="debt-line">
                        <div class="debt-part"><div class="user-avatar" style="width:24px;height:24px;font-size:0.8rem;">${t.from.charAt(0)}</div>${t.from}</div>
                        <div class="debt-arrow"><span>pays <span class="debt-amount">${appSettings.currency}${t.amount.toFixed(2)}</span> to</span>
                        <button class="btn-settle-small" onclick="openSettleModal(${groupId}, ${t.fromId}, ${t.toId}, ${t.amount})">Settle</button></div>
                        <div class="debt-part"><div class="user-avatar" style="width:24px;height:24px;font-size:0.8rem;">${t.to.charAt(0)}</div>${t.to}</div>
                    </div>`).join('');
            }
            document.getElementById('summary-modal').classList.add('active');
        }
        
        function openBreakdownModal(groupId) {
            const group = groups.find(g => g.id === groupId);
            const groupFriends = friends.filter(f => f.groupId === groupId);
            const groupActivities = activities.filter(a => a.groupId === groupId && a.type !== 'settlement'); 
            
            if(!group || groupFriends.length === 0) return;
            
            document.getElementById('breakdown-title').innerText = `${group.name} Breakdown`;
            
            // Aggregate expenses by user
            const userExpenses = {};
            groupFriends.forEach(f => {
                userExpenses[f.id] = {
                    name: f.name,
                    paidItems: [],
                    paidTotal: 0,
                    sharedItems: [],
                    sharedTotal: 0
                };
            });

            groupActivities.forEach(act => {
                // 1. Track Payments
                if(act.payers) {
                    act.payers.forEach(p => {
                        if(userExpenses[p.id]) {
                            userExpenses[p.id].paidItems.push({ desc: act.desc, amount: p.amount, date: act.date });
                            userExpenses[p.id].paidTotal += p.amount;
                        }
                    });
                }
                
                // 2. Track Participation (Split against)
                if(act.consumers) {
                    act.consumers.forEach(c => {
                        if(userExpenses[c.id]) {
                            userExpenses[c.id].sharedItems.push({ desc: act.desc, amount: c.amount, date: act.date });
                            userExpenses[c.id].sharedTotal += c.amount;
                        }
                    });
                }
            });

            let html = '';
            const currency = appSettings.currency;
            groupFriends.forEach(f => {
                const data = userExpenses[f.id];
                if(!data) return;
                
                data.paidItems.sort((a,b) => new Date(b.date) - new Date(a.date));
                data.sharedItems.sort((a,b) => new Date(b.date) - new Date(a.date));

                const paidHtml = data.paidItems.length > 0 
                    ? data.paidItems.map(item => `<div class="breakdown-item"><div><span class="date">${new Date(item.date).toLocaleDateString(undefined, {month:'short', day:'numeric'})}</span>${item.desc}</div><div style="font-weight:600;">${currency}${item.amount.toFixed(2)}</div></div>`).join('')
                    : '<div class="breakdown-item" style="justify-content:center; font-style:italic; color:var(--text-light);">No expenses paid</div>';

                const splitHtml = data.sharedItems.length > 0 
                    ? data.sharedItems.map(item => `<div class="breakdown-item"><div><span class="date">${new Date(item.date).toLocaleDateString(undefined, {month:'short', day:'numeric'})}</span>${item.desc}</div><div>${currency}${item.amount.toFixed(2)}</div></div>`).join('')
                    : '<div class="breakdown-item" style="justify-content:center; font-style:italic; color:var(--text-light);">No expenses shared</div>';

                const net = data.paidTotal - data.sharedTotal;
                const netClass = net >= 0 ? 'text-green' : 'text-red';
                const netLabel = net >= 0 ? 'Gets back' : 'Owes';

                html += `
                    <div class="breakdown-section">
                        <div class="breakdown-user">
                            <div style="display:flex; align-items:center; gap:8px;">
                                <div class="user-avatar" style="width:28px;height:28px;font-size:0.9rem;">
                                    ${data.name.charAt(0).toUpperCase()}
                                </div>
                                <span>${data.name}</span>
                            </div>
                            <div class="${netClass}" style="font-size:0.9rem;">
                                ${netLabel} ${currency}${Math.abs(net).toFixed(2)}
                            </div>
                        </div>
                        <div class="breakdown-columns">
                            <div class="breakdown-col">
                                <div class="breakdown-col-header paid">
                                    <span>Paid</span>
                                    <span>${currency}${data.paidTotal.toFixed(2)}</span>
                                </div>
                                <div>${paidHtml}</div>
                            </div>
                            <div class="breakdown-col">
                                <div class="breakdown-col-header split">
                                    <span>Shared</span>
                                    <span>${currency}${data.sharedTotal.toFixed(2)}</span>
                                </div>
                                <div>${splitHtml}</div>
                            </div>
                        </div>
                    </div>
                `;
            });

            breakdownList.innerHTML = html;
            document.getElementById('breakdown-modal').classList.add('active');
        }

        // --- Assignments to Window ---
        window.openSettingsModal = openSettingsModal;
        window.openResetModal = openResetModal;
        window.executeReset = executeReset;
        window.openGroupModal = openGroupModal;
        window.openFriendModal = openFriendModal;
        window.closeModal = closeModal;
        window.openSettleModal = openSettleModal;
        window.updateSettleSuggestion = updateSettleSuggestion;
        window.openSummaryModal = openSummaryModal;
        window.openBreakdownModal = openBreakdownModal; 
        window.updateDropdowns = updateDropdowns; 
        window.openExpenseModal = openExpenseModal; 
        
        window.openMoreAppsModal = function() {
            document.getElementById('more-apps-modal').classList.add('active');
        }
        
        // --- Tip Logic ---
        window.openTipModal = function() {
            document.getElementById('tip-modal').classList.add('active');
            document.getElementById('tip-bill-amount').value = '';
            document.getElementById('tip-split-count').value = 1;
            window.setTipPct(15);
        }
        window.setTipPct = function(pct) {
            currentTipPct = pct;
            if (pct !== 'custom') {
                 document.getElementById('tip-custom-pct').value = '';
                 document.querySelectorAll('.tip-options .chip').forEach(c => c.classList.remove('active'));
                 document.getElementById(`tip-${pct}`)?.classList.add('active');
            } else {
                 document.querySelectorAll('.tip-options .chip').forEach(c => c.classList.remove('active'));
            }
            window.calculateTip();
        }
        window.setCustomTip = function() {
             const val = parseFloat(document.getElementById('tip-custom-pct').value);
             if (!isNaN(val)) { window.setTipPct('custom'); currentTipPct = val; window.calculateTip(); }
        }
        window.adjustSplit = function(delta) {
            const el = document.getElementById('tip-split-count');
            let count = parseInt(el.value) || 1;
            count = Math.max(1, count + delta);
            el.value = count;
            window.calculateTip();
        }
        window.calculateTip = function() {
            const bill = parseFloat(document.getElementById('tip-bill-amount').value) || 0;
            let pct = currentTipPct;
            if (document.getElementById('tip-custom-pct').value !== '') pct = parseFloat(document.getElementById('tip-custom-pct').value) || 0;
            const count = parseInt(document.getElementById('tip-split-count').value) || 1;
            const tipAmt = bill * (pct / 100);
            const total = bill + tipAmt;
            document.getElementById('res-tip-amount').innerText = `${appSettings.currency}${tipAmt.toFixed(2)}`;
            document.getElementById('res-total-amount').innerText = `${appSettings.currency}${total.toFixed(2)}`;
            document.getElementById('res-per-person').innerText = `${appSettings.currency}${(total / count).toFixed(2)}`;
        }

        // --- Export Logic with Print Styles & Charts ---
        window.exportData = function() {
            const data = { groups: groups, friends: friends, activities: activities, appSettings: appSettings };
            const dataStr = JSON.stringify(data, null, 2);
            const blob = new Blob([dataStr], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `fairshare_data_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // NEW: Initiate Import (reads file, then opens confirmation modal)
        window.initiateImport = function(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (data.groups && data.friends && data.activities) {
                        importDataBuffer = data; // Store data in buffer
                        closeModal('settings-modal');
                        
                        // Open confirmation modal
                        confirmTitle.innerText = "Confirm Data Import";
                        confirmMessage.innerText = "Are you sure you want to overwrite all current data with this imported file? This action is irreversible.";
                        confirmWarning.style.display = 'block';
                        confirmWarning.innerText = "WARNING: All unsaved data will be lost!";
                        btnConfirmAction.onclick = window.executeImport;
                        btnConfirmAction.innerText = "Overwrite Data";
                        
                        confirmModal.classList.add('active');

                    } else { 
                        // Use the existing alert modal for better UX than native alert()
                        document.getElementById('alert-modal').querySelector('.modal-text').innerText = "Invalid file format. Please ensure the file contains 'groups', 'friends', and 'activities' arrays.";
                        document.getElementById('alert-modal').classList.add('active');
                    }
                } catch (error) { 
                    document.getElementById('alert-modal').querySelector('.modal-text').innerText = "Error parsing file. Check if the file is valid JSON.";
                    document.getElementById('alert-modal').classList.add('active');
                    console.error("Import error:", error); 
                }
                // Reset file input so same file can be selected again
                event.target.value = '';
            };
            reader.readAsText(file);
        }
        
        // NEW: Execute Import (triggered by confirmation modal)
        window.executeImport = function() {
            if (!importDataBuffer) return;
            
            groups = importDataBuffer.groups;
            friends = importDataBuffer.friends;
            activities = importDataBuffer.activities;
            if (importDataBuffer.appSettings) appSettings = importDataBuffer.appSettings;
            
            saveData();
            closeModal('confirm-modal');
            
            document.getElementById('alert-modal').querySelector('.modal-text').innerText = "Data imported successfully!";
            document.getElementById('alert-modal').classList.add('active');
        }

        window.exportGroupHTML = function(groupId) {
            const group = groups.find(g => g.id === groupId);
            if (!group) return;
            
            const groupFriends = friends.filter(f => f.groupId === groupId);
            const groupActivities = activities.filter(a => a.groupId === groupId);
            const settlements = simplifyDebts(groupFriends);
            const currency = appSettings.currency;

            // Calc stats for charts
            let totalSpent = 0;
            const spendingByPerson = {};
            const spendingByCategory = {};
            const spendingByMonth = {};

            groupActivities.filter(a => a.type === 'expense').forEach(act => {
                const amt = parseFloat(act.amount);
                totalSpent += amt;
                
                // Category
                const cat = act.category || 'Uncategorized';
                spendingByCategory[cat] = (spendingByCategory[cat] || 0) + amt;

                // Month
                const month = new Date(act.date).toLocaleString('default', { month: 'long', year: 'numeric' });
                spendingByMonth[month] = (spendingByMonth[month] || 0) + amt;

                // Person (Payer) - simpler visualization than split for now
                if(act.payers) {
                    act.payers.forEach(p => {
                        const pName = groupFriends.find(f => f.id == p.id)?.name || 'Unknown';
                        spendingByPerson[pName] = (spendingByPerson[pName] || 0) + p.amount;
                    });
                }
            });
            
            // Calculate Breakdown Lists
            const userExpenses = {};
            groupFriends.forEach(f => {
                userExpenses[f.id] = { name: f.name, paidItems: [], paidTotal: 0, sharedItems: [], sharedTotal: 0 };
            });
            groupActivities.filter(a => a.type !== 'settlement').forEach(act => {
                if(act.payers) act.payers.forEach(p => { if(userExpenses[p.id]) { userExpenses[p.id].paidItems.push({desc:act.desc, amount:p.amount, date:act.date}); userExpenses[p.id].paidTotal+=p.amount; }});
                if(act.consumers) act.consumers.forEach(c => { if(userExpenses[c.id]) { userExpenses[c.id].sharedItems.push({desc:act.desc, amount:c.amount, date:act.date}); userExpenses[c.id].sharedTotal+=c.amount; }});
            });
            
            // Sort Lists
            Object.values(userExpenses).forEach(data => {
                data.paidItems.sort((a,b) => new Date(b.date) - new Date(a.date));
                data.sharedItems.sort((a,b) => new Date(b.date) - new Date(a.date));
            });
            
            // Render Breakdown
            const breakdownHTML = Object.values(userExpenses).map(data => {
                const net = data.paidTotal - data.sharedTotal;
                const netColor = net >= 0 ? 'positive' : 'negative';
                const netText = net >= 0 ? `Gets back ${currency}${Math.abs(net).toFixed(2)}` : `Owes ${currency}${Math.abs(net).toFixed(2)}`;
                const renderList = (items) => items.length ? items.map(i => `<div class="list-row"><span>${i.desc} <span style="color:#999;font-size:0.8em;">(${new Date(i.date).toLocaleDateString()})</span></span><span>${currency}${i.amount.toFixed(2)}</span></div>`).join('') : '<div class="empty-list">-</div>';
                return `<div class="user-block"><div class="user-header"><h3>${data.name}</h3><span class="amount ${netColor}">${netText}</span></div><div class="columns"><div class="column"><div class="col-title" style="color:#1cc29f;">Paid (${currency}${data.paidTotal.toFixed(2)})</div>${renderList(data.paidItems)}</div><div class="column"><div class="col-title" style="color:#e67e22;">Shared (${currency}${data.sharedTotal.toFixed(2)})</div>${renderList(data.sharedItems)}</div></div></div>`;
            }).join('');

            // Helper for Bar Chart
            const renderBar = (label, val, total, color) => {
                const pct = total > 0 ? (val / total) * 100 : 0;
                return `<div style="margin-bottom:12px;"><div style="display:flex; justify-content:space-between; font-size:0.9rem; margin-bottom:4px; font-weight:500;"><span>${label}</span><span>${currency}${val.toFixed(2)} <span style="color:#999; font-size:0.8em; font-weight:400;">(${pct.toFixed(1)}%)</span></span></div><div style="background:#f0f0f0; height:12px; border-radius:6px; overflow:hidden;"><div style="background:${color}; height:100%; width:${pct}%"></div></div></div>`;
            };
            const personChartHTML = Object.entries(spendingByPerson).sort((a,b) => b[1] - a[1]).map(([k,v]) => renderBar(k, v, totalSpent, '#1cc29f')).join('');
            const categoryChartHTML = Object.entries(spendingByCategory).sort((a,b) => b[1] - a[1]).map(([k,v]) => renderBar(k, v, totalSpent, '#3b82f6')).join('');
            
            // Settlement Flow Boxes
            const settlementFlowHTML = settlements.map(s => `
                <div style="display:flex; align-items:center; gap:8px; padding:10px 0; border-bottom: 1px dashed #eee;">
                    <span style="font-weight:600; color:#444;">${s.from}</span>
                    <span style="color:#aaa;">pays</span>
                    <strong style="color:#1cc29f;">${currency}${s.amount.toFixed(2)}</strong>
                    <span style="color:#aaa;">to</span>
                    <span style="font-weight:600; color:#444;">${s.to}</span>
                </div>
            `).join('') || '<div style="text-align:center; color:#555; font-style:italic;">Everyone is settled up!</div>';

            let html = `
            <!DOCTYPE html>
            <html>
            <head><meta charset="UTF-8"><title>${group.name} Report</title>
            <style>
                body { font-family: sans-serif; padding: 40px; max-width: 800px; margin: 0 auto; color: #333; }
                h1 { color: #1cc29f; border-bottom: 2px solid #eee; padding-bottom: 10px; }
                h2 { margin-top: 30px; font-size: 1.2rem; color: #555; border-bottom: 1px solid #eee; padding-bottom: 5px; }
                table { width: 100%; border-collapse: collapse; margin-top: 10px; }
                th, td { padding: 10px; text-align: left; border-bottom: 1px solid #eee; }
                th { background-color: #f8fcfb; }
                .amount { font-weight: bold; font-family: monospace; }
                .positive { color: #1cc29f; } .negative { color: #ff6565; }
                .chart-box { display: flex; gap: 20px; flex-wrap: wrap; }
                .chart-col { flex: 1; min-width: 250px; border: 1px solid #eee; padding: 15px; border-radius: 8px; }
                .user-block { margin-bottom: 25px; border: 1px solid #eee; border-radius: 8px; overflow: hidden; page-break-inside: avoid; }
                .user-header { background: #f9f9f9; padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; }
                .user-header h3 { margin: 0; font-size: 1.1rem; }
                .columns { display: flex; }
                .column { flex: 1; padding: 15px; font-size: 0.9rem; }
                .column:first-child { border-right: 1px solid #eee; }
                .col-title { font-weight: 700; text-transform: uppercase; font-size: 0.8rem; margin-bottom: 10px; }
                .list-row { display: flex; justify-content: space-between; margin-bottom: 6px; border-bottom: 1px dashed #f0f0f0; padding-bottom: 4px; }
                .empty-list { font-style: italic; color: #aaa; }
                .settlement-flow { border: 1px solid #1cc29f; padding: 15px; border-radius: 8px; background: #f0fdf9; }
                @media print { body { padding: 0; } .no-print { display: none; } .chart-box, .user-block { page-break-inside: avoid; } }
            </style>
            </head>
            <body>
                <div style="text-align:right; color:#888; font-size:0.8rem;">Generated ${new Date().toLocaleDateString()}</div>
                <h1>${group.name} Report</h1>
                
                <div style="margin-bottom: 30px; font-size: 1.2rem;"><strong>Total Group Spending:</strong> <span style="color:#1cc29f;">${currency}${totalSpent.toFixed(2)}</span></div>

                <h2>Spending Overview</h2>
                <div class="chart-box">
                    <div class="chart-col"><h3>Spending by Person (Paid)</h3>${personChartHTML || '<div style="color:#999; font-style:italic;">No data</div>'}</div>
                    <div class="chart-col"><h3>Spending by Category</h3>${categoryChartHTML || '<div style="color:#999; font-style:italic;">No data</div>'}</div>
                </div>

                <h2>Net Balances</h2>
                <table><thead><tr><th>Participant</th><th>Net Balance</th></tr></thead><tbody>
                        ${groupFriends.map(f => `<tr><td>${f.name}</td><td class="${f.balance>=0?'positive':'negative'} amount">${f.balance>=0?'+':''}${currency}${f.balance.toFixed(2)}</td></tr>`).join('')}
                </tbody></table>
                
                <h2>Suggested Settlements</h2>
                <div class="settlement-flow">
                    ${settlementFlowHTML}
                </div>
                
                <h2>Member Breakdown</h2>
                ${breakdownHTML}

                <h2>Activity Ledger</h2>
                <table><thead><tr><th>Date</th><th>Description</th><th>Category</th><th>Type</th><th>Amount</th><th>Payer</th></tr></thead><tbody>
                        ${groupActivities.slice().reverse().map(act => {
                             const dateStr = new Date(act.date).toLocaleDateString();
                             const isSettle = act.type === 'settlement';
                             return `<tr><td>${dateStr}</td><td>${act.desc||(isSettle?'Payment':'Expense')}</td><td>${act.category||'-'}</td><td>${isSettle?'Settlement':'Expense'}</td><td class="amount">${currency}${act.amount.toFixed(2)}</td><td>${act.payerName} ${isSettle?'&#8594; '+act.recipientName:''}</td></tr>`;
                        }).join('')}
                </tbody></table>
            </body></html>`;
            
            const blob = new Blob([html], { type: 'text/html' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `${group.name.replace(/[^a-z0-9]/gi, '_')}_Report.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }
        
        // --- Remaining Core Logic ---

        function recalculateAllBalances() {
            friends.forEach(f => f.balance = 0);
            activities.forEach(act => {
                const amt = parseFloat(act.amount)||0;
                if(act.type==='expense') {
                    if(act.payers) act.payers.forEach(p=>{const f=friends.find(x=>x.id==p.id); if(f && f.groupId==act.groupId) f.balance+=parseFloat(p.amount); });
                    if(act.consumers) act.consumers.forEach(c=>{const f=friends.find(x=>x.id==c.id); if(f && f.groupId==act.groupId) f.balance-=parseFloat(c.amount); });
                } else if(act.type==='settlement') {
                    if(act.payerId && act.recipientId) {
                        const p = friends.find(x=>x.id==act.payerId);
                        const r = friends.find(x=>x.id==act.recipientId);
                        if(p && p.groupId==act.groupId) p.balance+=amt;
                        if(r && r.groupId==act.groupId) r.balance-=amt;
                    }
                }
            });
        }
        
        function calculateTotals() {
            let totalPositive = 0;
            let totalNegative = 0;

            const friendsToSum = expandedGroupId 
                ? friends.filter(f => f.groupId === expandedGroupId)
                : friends;

            friendsToSum.forEach(f => {
                if (f.balance > 0) totalPositive += f.balance;
                if (f.balance < 0) totalNegative += Math.abs(f.balance);
            });
            
            totalOwedEl.innerText = `${appSettings.currency}${totalPositive.toFixed(2)}`;
            totalOweEl.innerText = `${appSettings.currency}${totalNegative.toFixed(2)}`;
        }

        function toggleShowArchived(checked) {
            appSettings.showArchived = checked;
            saveData();
        }
        
        // FIX: Renamed updateCurrency to break recursion loop
        function updateCurrencyUI() {
             document.querySelectorAll('.currency-dynamic').forEach(el => el.innerText = appSettings.currency);
        }

        function updateCurrencyAndSave(currency) {
            appSettings.currency = currency;
            updateCurrencyUI();
            saveData(); // Only save/render when the setting is changed by the user
        }

        function render() {
            updateCurrencyUI(); // Update symbols first
            recalculateAllBalances();
            calculateTotals();
            // Render Friends List
            friendsListEl.innerHTML = '';
            if (groups.length === 0) friendsListEl.innerHTML = '<div class="empty-state">No groups</div>';
            
            // Sort groups by ID (creation time) descending
            const sortedGroups = [...groups].sort((a, b) => b.id - a.id);

            sortedGroups.filter(g => !g.archived || appSettings.showArchived).forEach(g => {
                const gFriends = friends.filter(f => f.groupId === g.id);
                const isExpanded = g.id === expandedGroupId;
                const div = document.createElement('div');
                div.className = `group-block ${isExpanded?'expanded':''} ${g.archived?'archived':''}`;
                div.innerHTML = `
                <div class="group-header" onclick="toggleGroup(${g.id})">
                    <div class="group-header-left"><span class="group-chevron">‚Ä∫</span><span>${g.name} ${g.archived?'(Archived)':''}</span></div>
                    <div class="group-actions">
                         <button class="btn-icon-group settle" onclick="event.stopPropagation(); openSettleModal(${g.id})">ü§ù</button>
                         <button class="btn-icon-group breakdown" onclick="event.stopPropagation(); openBreakdownModal(${g.id})">üìÑ</button>
                         <button class="btn-icon-group summary" onclick="event.stopPropagation(); openSummaryModal(${g.id})">üìä</button>
                         <button class="btn-icon-group export" onclick="event.stopPropagation(); exportGroupHTML(${g.id})">üì§</button>
                         <button class="btn-icon-group archive" onclick="event.stopPropagation(); initiateArchiveGroup(${g.id})">üìÇ</button>
                         <button class="btn-icon-group delete" onclick="event.stopPropagation(); initiateDeleteGroup(${g.id})">&times;</button>
                    </div>
                </div>
                <div class="group-content">
                    ${gFriends.length ? gFriends.map(f => `<div class="list-item"><div class="item-left"><div class="user-avatar">${f.name.charAt(0)}</div><div class="item-details"><h3>${f.name}</h3></div></div><div style="display:flex;align-items:center;"><div class="item-right"><span class="status">${f.balance>0.01?'gets back':(f.balance<-0.01?'owes':'settled up')}</span><span class="value ${f.balance>=0?'text-green':'text-red'}">${appSettings.currency}${Math.abs(f.balance).toFixed(2)}</span></div><button class="btn-delete-friend" onclick="initiateDeleteFriend(${f.id})">&times;</button></div></div>`).join('') : '<div class="empty-state">No members</div>'}
                </div>`;
                friendsListEl.appendChild(div);
            });
            renderActivity();
        }
        
        function renderActivity() {
            const query = searchInput.value.toLowerCase();
            let displayActs = activities;
            if (expandedGroupId) displayActs = activities.filter(a => a.groupId === expandedGroupId);
            
            if(query) {
                displayActs = displayActs.filter(a => a.desc.toLowerCase().includes(query) || a.amount.toString().includes(query) || a.payerName.toLowerCase().includes(query));
            }

            if (displayActs.length === 0) {
                activityListEl.innerHTML = '<div class="empty-state">No activity found</div>';
                return;
            }
            
            activityListEl.innerHTML = [...displayActs].reverse().map(act => {
                const dateStr = new Date(act.date).toLocaleDateString(undefined, {month:'short', day:'numeric'});
                const cur = appSettings.currency;
                if(act.type === 'settlement') {
                    return `<div class="list-item settlement"><div class="item-left"><div class="icon-box">ü§ù</div><div class="item-details"><h3>${act.payerName} paid ${act.recipientName}</h3><p>Settlement</p></div></div><div class="item-right"><span class="status">${dateStr}</span><span class="value text-green">${cur}${parseFloat(act.amount).toFixed(2)}</span></div><button class="btn-edit-activity" onclick="initiateDeleteActivity(${act.id})" style="margin-left:4px; color:var(--danger);">üóë</button></div>`;
                }
                // Expense
                let sub = `${act.payerName} paid ${cur}${parseFloat(act.amount).toFixed(2)}`;
                if(act.payers && act.payers.length > 1) sub = `Multiple people paid ${cur}${parseFloat(act.amount).toFixed(2)}`;
                const categoryIcon = act.category ? act.category.split(' ')[0] : 'üßæ'; 
                
                let sharedText = "Group";
                if(act.consumers && act.consumers.length > 0) {
                     const groupMems = friends.filter(f=>f.groupId==act.groupId).length;
                     if(act.consumers.length == groupMems) sharedText = "Everyone";
                     else if(act.consumers.length <= 2) {
                         const names = act.consumers.map(c => { const f = friends.find(x=>x.id==c.id); return f ? f.name.split(' ')[0] : '?'; });
                         sharedText = names.join(' & ');
                     } else {
                         const f = friends.find(x=>x.id==act.consumers[0].id);
                         const name = f ? f.name.split(' ')[0] : '?';
                         sharedText = `${name} +${act.consumers.length-1}`;
                     }
                }

                return `<div class="list-item"><div class="item-left"><div class="icon-box" title="${act.category||''}">${categoryIcon}</div><div class="item-details"><h3>${act.desc}</h3><p>${sub}</p></div></div><div class="item-right"><div style="text-align:right;"><span class="status">${dateStr}</span><span class="value text-gray" style="font-size:0.8rem;">${sharedText}</span></div></div><div style="display:flex;"><button class="btn-edit-activity" onclick="openEditModal(${act.id})">‚úé</button><button class="btn-edit-activity" onclick="initiateDeleteActivity(${act.id})" style="margin-left:4px; color:var(--danger);">üóë</button></div></div>`;
            }).join('');
        }
        
        function toggleGroup(id) { expandedGroupId = (expandedGroupId===id) ? null : id; render(); }
        window.toggleGroup = toggleGroup;
        
        // --- Other Window Assignments (Deleted logic removed for brevity) ---
        window.updateCurrencyAndSave = updateCurrencyAndSave;
        window.toggleShowArchived = toggleShowArchived;
        window.exportGroupHTML = exportGroupHTML;
        
        // --- Deletion Logic Assignments ---
        window.initiateArchiveGroup = function(id) {
             const group = groups.find(g => g.id === id);
             if (group) {
                 group.archived = !group.archived;
                 if (group.archived && expandedGroupId === id) expandedGroupId = null;
                 saveData();
             }
        }
        
        window.initiateDeleteGroup = function(id) {
            groupToDeleteId = id;
            const gFriends = friends.filter(f => f.groupId === id);
            const hasBalance = gFriends.some(f => Math.abs(f.balance) > 0.01);
            confirmTitle.innerText = "Delete Group";
            confirmMessage.innerText = `Are you sure you want to delete "${groups.find(g=>g.id===id)?.name}" and all its members?`;
            confirmWarning.style.display = hasBalance ? 'block' : 'none';
            confirmWarning.innerText = hasBalance ? `WARNING: This group has unpaid balances! Deleting it will remove those debts.` : '';
            btnConfirmAction.onclick = window.executeDeleteGroup;
            btnConfirmAction.innerText = "Delete Group";
            confirmModal.classList.add('active');
        }

        window.executeDeleteGroup = function() {
            if (groupToDeleteId === null) return;
            if(expandedGroupId === groupToDeleteId) expandedGroupId = null;
            groups = groups.filter(g => g.id !== groupToDeleteId);
            friends = friends.filter(f => f.groupId !== groupToDeleteId);
            activities = activities.filter(a => a.groupId !== groupToDeleteId);
            saveData();
            closeModal('confirm-modal');
            groupToDeleteId = null;
        }

        window.initiateDeleteFriend = function(id) {
            friendToDeleteId = id;
            const friend = friends.find(f => f.id === id);
            if (!friend) return;
            const hasBalance = Math.abs(friend.balance) > 0.01;
            confirmTitle.innerText = "Delete Friend";
            confirmMessage.innerText = `Are you sure you want to delete ${friend.name} from their group?`;
            confirmWarning.style.display = hasBalance ? 'block' : 'none';
            confirmWarning.innerText = hasBalance ? `WARNING: ${friend.name} has an outstanding balance of ${appSettings.currency}${Math.abs(friend.balance).toFixed(2)}. Deleting will remove this debt.` : '';
            btnConfirmAction.onclick = window.executeDeleteFriend;
            btnConfirmAction.innerText = "Delete Friend";
            confirmModal.classList.add('active');
        }

        window.executeDeleteFriend = function() {
            if (friendToDeleteId === null) return;
            friends = friends.filter(f => f.id !== friendToDeleteId);
            // Activities cleanup should happen during recalculation if IDs are gone, but we rely on replay
            saveData();
            closeModal('confirm-modal');
            friendToDeleteId = null;
        }
        
        window.initiateDeleteActivity = function(id) {
            activityToDeleteId = id;
            const act = activities.find(a => a.id === id);
            if(!act) return;
            confirmTitle.innerText = "Delete Expense";
            confirmMessage.innerText = `Are you sure you want to delete "${act.desc || 'this item'}"? This will reverse the balances.`;
            confirmWarning.style.display = 'none';
            btnConfirmAction.onclick = window.executeDeleteActivity;
            btnConfirmAction.innerText = "Delete Expense";
            confirmModal.classList.add('active');
        }

        window.executeDeleteActivity = function() {
            if (activityToDeleteId === null) return;
            activities = activities.filter(a => a.id !== activityToDeleteId);
            saveData();
            closeModal('confirm-modal');
            activityToDeleteId = null;
        }

        window.openEditModal = function(actId) {
            const act = activities.find(a => a.id === actId);
            if(!act || act.type === 'settlement') {
                alert("Cannot edit this item.");
                return;
            }
            editingActivityId = actId;
            expenseModalTitle.innerText = "Edit expense";
            btnSaveExpense.innerText = "Update Expense";
            expenseModal.classList.add('active');
            
            // Populating logic here (restored for full functionality)
            window.updateDropdowns();
            expenseGroupSelect.value = act.groupId;
            expenseGroupSelect.disabled = true; 
            
            document.getElementById('desc-input').value = act.desc;
            document.getElementById('amount-input').value = act.amount;
            document.getElementById('category-input').value = act.category || '';
            dateInput.value = act.date;
            
            currentSplitMethod = null;
            window.setSplitMethod(act.splitMethod || 'equal'); 
            
            if(act.payers.length > 1) {
                payerSelect.value = 'multiple';
                window.handlePayerChange();
                setTimeout(() => {
                    act.payers.forEach(p => {
                        const inp = multiPayerContainer.querySelector(`input[data-id="${p.id}"]`);
                        if(inp) inp.value = p.amount;
                    });
                    window.updateRemainingBalance();
                }, 0);
            } else {
                if (act.payers.length > 0) {
                    payerSelect.value = act.payers[0].id;
                }
                window.handlePayerChange();
            }
            
            setTimeout(() => {
                const consumerIds = act.consumers.map(c => c.id);
                if(act.splitMethod === 'equal') {
                    splitContainer.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                        const isChecked = consumerIds.includes(parseInt(cb.value));
                        cb.checked = isChecked;
                        cb.closest('.chip').classList.toggle('selected', isChecked);
                    });
                } else if (act.splitMethod === 'shares') {
                     act.consumers.forEach(c => {
                         const inp = splitContainer.querySelector(`input[data-id="${c.id}"]`);
                         // Since we are changing to buttons, read only the value of the input
                         if(inp && c.shares) inp.value = c.shares;
                     });
                } else if (act.splitMethod === 'percent') {
                    act.consumers.forEach(c => {
                         const pct = (c.amount / act.amount) * 100;
                         const inp = splitContainer.querySelector(`input[data-id="${c.id}"]`);
                         if(inp && c.percent) inp.value = c.percent.toFixed(1);
                    });
                } else if (act.splitMethod === 'amount') { // Handle edit for 'amount' split
                    act.consumers.forEach(c => {
                         const inp = splitContainer.querySelector(`input[data-id="${c.id}"]`);
                         if(inp && c.amount) inp.value = parseFloat(c.amount).toFixed(2);
                    });
                }
                window.updateSplitSummary();
            }, 50);
        }

        window.updateDropdowns = function() {
            if(expenseGroupSelect) {
                const currentVal = expenseGroupSelect.value;
                const activeGroups = groups.filter(g => !g.archived);
                expenseGroupSelect.innerHTML = activeGroups.map(g => 
                    `<option value="${g.id}">${g.name}</option>`
                ).join('');
                if (currentVal && activeGroups.some(g => g.id == currentVal)) {
                    expenseGroupSelect.value = currentVal;
                } else if (activeGroups.length > 0) {
                    expenseGroupSelect.value = activeGroups[0].id;
                }
            }
            if(groupSelectAssign) {
                const activeGroups = groups.filter(g => !g.archived).sort((a, b) => b.id - a.id);
                groupSelectAssign.innerHTML = activeGroups.map(g => 
                    `<option value="${g.id}">${g.name}</option>`
                ).join('');
                 // Set default to the newest group (last in sorted list)
                if (activeGroups.length > 0) {
                    groupSelectAssign.value = activeGroups[activeGroups.length - 1].id;
                }
            }
        }
        
        // --- Activity Form Logic (Restored) ---
        window.handlePayerChange = function() {
            const isMultiple = payerSelect.value === 'multiple';
            const amountInput = document.getElementById('amount-input');
            
            if (isMultiple) {
                multiPayerContainer.style.display = 'block';
                // amountInput.readOnly = true; // Decided against this for better UX
                window.updateRemainingBalance();
            } else {
                multiPayerContainer.style.display = 'none';
                amountInput.readOnly = false;
            }
        }
        
        window.updateRemainingBalance = function() {
            const totalAmount = parseFloat(document.getElementById('amount-input').value) || 0;
            const inputs = multiPayerContainer.querySelectorAll('.multi-payer-input');
            let enteredTotal = 0;
            
            inputs.forEach(inp => {
                const val = parseFloat(inp.value);
                if (!isNaN(val)) enteredTotal += val;
            });

            const remaining = totalAmount - enteredTotal;
            const remainingEl = document.getElementById('multi-payer-remaining-display');
            
            if(remainingEl) {
                if (Math.abs(remaining) < 0.01) {
                    remainingEl.innerText = "Total matches";
                    remainingEl.className = "multi-payer-remaining success";
                } else if (remaining > 0) {
                    remainingEl.innerText = `Remaining: ${appSettings.currency}${remaining.toFixed(2)}`;
                    remainingEl.className = "multi-payer-remaining";
                } else {
                    remainingEl.innerText = `Over by: ${appSettings.currency}${Math.abs(remaining).toFixed(2)}`;
                    remainingEl.className = "multi-payer-remaining error";
                }
            }
        }
        
        window.setSplitMethod = function(method) {
            if (method === 'equal' && currentSplitMethod === 'equal') {
                window.toggleSelectAll();
                return;
            }
            
            currentSplitMethod = method;
            document.querySelectorAll('.split-tab').forEach(tab => tab.classList.remove('active'));
            document.getElementById(`tab-${method}`).classList.add('active');
            window.updateExpenseParticipants(); 
        }
        
        window.toggleSelectAll = function() {
            const checkboxes = splitContainer.querySelectorAll('input[type="checkbox"]');
            if (checkboxes.length === 0) return;

            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            const newState = !allChecked;
            
            checkboxes.forEach(cb => {
                cb.checked = newState;
                const chip = cb.closest('.chip');
                if(newState) {
                    chip.classList.add('selected');
                } else {
                    chip.classList.remove('selected');
                }
            });
            window.updateSplitSummary();
        }

        window.adjustShareCount = function(button, delta) {
            const chipRight = button.closest('.chip-right');
            const input = chipRight.querySelector('.split-input-val');
            let currentVal = parseInt(input.value) || 0;
            
            let newVal = currentVal + delta;
            newVal = Math.max(0, newVal); // Shares cannot be negative
            
            input.value = newVal;
            window.updateSplitSummary();
        }

        window.updateExpenseParticipants = function() {
            const groupId = parseInt(expenseGroupSelect.value);
            if(!groupId) return;

            const groupFriends = friends.filter(f => f.groupId === groupId);
            
            let payerHtml = ``;
            groupFriends.forEach(f => {
                payerHtml += `<option value="${f.id}">${f.name}</option>`;
            });
            payerHtml += `<option value="multiple">Multiple people</option>`;
            
            const currentPayerVal = payerSelect.value;
            payerSelect.innerHTML = payerHtml;
            
            if(currentPayerVal && currentPayerVal !== 'you' && (currentPayerVal === 'multiple' || groupFriends.some(f => f.id == currentPayerVal))) {
                 payerSelect.value = currentPayerVal;
            } else if (groupFriends.length > 0) {
                 payerSelect.value = groupFriends[0].id;
            }

            window.generateMultiPayerInputs(groupFriends);
            window.handlePayerChange(); 

            let splitHtml = '';
            const createChip = (id, name) => {
                const avatarEl = `<div class="chip-avatar">${name.charAt(0).toUpperCase()}</div>`;

                if (currentSplitMethod === 'equal') {
                    return `
                    <div class="chip selectable selected" data-id="${id}" onclick="toggleChip(this)">
                        <div class="chip-left">
                            ${avatarEl}
                            <span>${name}</span>
                        </div>
                        <input type="checkbox" value="${id}" checked>
                        <div class="chip-right"></div>
                    </div>`;
                } else if (currentSplitMethod === 'shares') {
                    return `
                    <div class="chip input-mode" data-id="${id}">
                        <div class="chip-left">
                            ${avatarEl}
                            <span>${name}</span>
                        </div>
                        <div class="chip-right">
                             <div class="share-counter-container">
                                <button type="button" class="share-btn" onclick="adjustShareCount(this, -1)">-</button>
                                <input type="number" class="split-input-val" data-id="${id}" value="1" min="0" step="1" readonly style="width: 40px; text-align: center;">
                                <button type="button" class="share-btn" onclick="adjustShareCount(this, 1)">+</button>
                             </div>
                             <span class="split-input-label">share(s)</span>
                        </div>
                    </div>`;
                } else if (currentSplitMethod === 'percent') {
                    return `
                    <div class="chip input-mode" data-id="${id}">
                        <div class="chip-left">
                            ${avatarEl}
                            <span>${name}</span>
                        </div>
                        <div class="chip-right">
                             <input type="number" class="split-input-val" data-id="${id}" value="0" min="0" max="100" step="0.1" oninput="updateSplitSummary()">
                             <span class="split-input-label">%</span>
                        </div>
                    </div>`;
                } else if (currentSplitMethod === 'amount') { 
                    return `
                    <div class="chip input-mode" data-id="${id}">
                        <div class="chip-left">
                            ${avatarEl}
                            <span>${name}</span>
                        </div>
                        <div class="chip-right">
                             <span class="currency-symbol currency-dynamic" style="font-weight:600; font-size:1rem;">${appSettings.currency}</span>
                             <input type="number" class="split-input-val" data-id="${id}" value="0.00" min="0" step="0.01" oninput="updateSplitSummary()" style="width: 80px;">
                        </div>
                    </div>`;
                }
            };

            groupFriends.forEach(f => {
                splitHtml += createChip(f.id, f.name);
            });
            
            splitContainer.innerHTML = splitHtml;
            window.updateCurrencyUI(); 
            window.updateSplitSummary();
        }

        window.generateMultiPayerInputs = function(groupFriends) {
            let multiHtml = ``; 
            groupFriends.forEach(f => {
                multiHtml += `
                    <div class="multi-payer-item">
                        <div class="multi-payer-label">${f.name}</div>
                        <input type="number" class="multi-payer-input" data-id="${f.id}" placeholder="0.00" min="0" step="0.01" oninput="updateRemainingBalance()">
                    </div>
                `;
            });
            multiHtml += `<div id="multi-payer-remaining-display" class="multi-payer-remaining">Remaining: ${appSettings.currency}0.00</div>`;
            multiPayerContainer.innerHTML = multiHtml;
        }

        window.updateSplitSummary = function() {
            const totalAmount = parseFloat(document.getElementById('amount-input').value) || 0;
            
            // Reset color for safety
            splitSummary.style.color = 'var(--text-light)';

            if (currentSplitMethod === 'equal') {
                const count = splitContainer.querySelectorAll('input[type="checkbox"]:checked').length;
                splitSummary.innerText = `Split equally between ${count} people`;
            } else if (currentSplitMethod === 'shares') {
                const totalShares = Array.from(splitContainer.querySelectorAll('.split-input-val')).reduce((sum, inp) => sum + (parseFloat(inp.value) || 0), 0);
                splitSummary.innerText = `Split by shares (Total Shares: ${totalShares})`;
            } else if (currentSplitMethod === 'percent') {
                const totalPct = Array.from(splitContainer.querySelectorAll('.split-input-val')).reduce((sum, inp) => sum + (parseFloat(inp.value) || 0), 0);
                splitSummary.innerText = `Split by percentage (Total: ${totalPct.toFixed(1)}%)`;
                if (Math.abs(totalPct - 100) > 0.1) splitSummary.style.color = 'var(--danger)';
            } else if (currentSplitMethod === 'amount') { 
                const inputs = splitContainer.querySelectorAll('.split-input-val');
                const sumAmounts = Array.from(inputs).reduce((sum, inp) => sum + (parseFloat(inp.value) || 0), 0);
                const remaining = totalAmount - sumAmounts;
                
                let summaryText = `Split by amount (Total: ${appSettings.currency}${sumAmounts.toFixed(2)})`;
                
                if (Math.abs(remaining) < 0.01) {
                    summaryText += ` - Total matched.`;
                    splitSummary.style.color = 'var(--primary)'; // Green/Success
                } else if (remaining > 0) {
                    summaryText += ` - ${appSettings.currency}${remaining.toFixed(2)} remaining.`;
                    splitSummary.style.color = 'var(--danger)';
                } else {
                    summaryText += ` - Over by ${appSettings.currency}${Math.abs(remaining).toFixed(2)}.`;
                    splitSummary.style.color = 'var(--danger)';
                }
                
                splitSummary.innerText = summaryText;
            }
        }

        window.toggleChip = function(element) {
            element.classList.toggle('selected');
            const checkbox = element.querySelector('input');
            checkbox.checked = element.classList.contains('selected');
            window.updateSplitSummary();
        };

        // --- Form Submissions ---

        expenseForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const desc = document.getElementById('desc-input').value;
            const amount = parseFloat(document.getElementById('amount-input').value);
            const category = document.getElementById('category-input').value;
            const dateVal = dateInput.value || new Date().toISOString().split('T')[0];
            const groupId = parseInt(expenseGroupSelect.value);
            
            // 1. Gather Payers
            let payers = [];
            const payerValue = payerSelect.value;
            
            if (payerValue === 'multiple') {
                const inputs = multiPayerContainer.querySelectorAll('.multi-payer-input');
                inputs.forEach(inp => {
                    const val = parseFloat(inp.value);
                    if (!isNaN(val) && val > 0) {
                        payers.push({ id: parseInt(inp.dataset.id), amount: val });
                    }
                });
            } else {
                payers.push({ id: parseInt(payerValue), amount: amount });
            }

            // 2. Gather Split Data (Consumers)
            let consumers = []; 
            
            if (currentSplitMethod === 'equal') {
                const checkboxes = splitContainer.querySelectorAll('input[type="checkbox"]:checked');
                const count = checkboxes.length;
                if (count === 0) {
                    document.getElementById('alert-modal').querySelector('.modal-text').innerText = "Select at least one person to split the expense.";
                    document.getElementById('alert-modal').classList.add('active');
                    return;
                }
                
                const costPerPerson = amount / count;
                checkboxes.forEach(cb => {
                    consumers.push({ id: parseInt(cb.value), amount: costPerPerson });
                });

            } else if (currentSplitMethod === 'shares') {
                const inputs = splitContainer.querySelectorAll('.split-input-val');
                let totalShares = 0;
                let tempConsumers = [];
                
                inputs.forEach(inp => {
                    const shares = parseFloat(inp.value) || 0;
                    if (shares > 0) {
                        totalShares += shares;
                        tempConsumers.push({ id: parseInt(inp.dataset.id), shares: shares });
                    }
                });
                
                if (totalShares === 0) {
                    document.getElementById('alert-modal').querySelector('.modal-text').innerText = "Total shares must be greater than 0.";
                    document.getElementById('alert-modal').classList.add('active');
                    return;
                }
                
                tempConsumers.forEach(c => {
                    const cost = (c.shares / totalShares) * amount;
                    consumers.push({ id: c.id, amount: cost, shares: c.shares });
                });

            } else if (currentSplitMethod === 'percent') {
                const inputs = splitContainer.querySelectorAll('.split-input-val');
                let totalPercent = 0;
                let tempConsumers = [];
                
                inputs.forEach(inp => {
                    const pct = parseFloat(inp.value) || 0;
                    if (pct > 0) {
                        totalPercent += pct;
                        tempConsumers.push({ id: parseInt(inp.dataset.id), pct: pct });
                    }
                });

                if (Math.abs(totalPercent - 100) > 0.1) {
                    document.getElementById('alert-modal').querySelector('.modal-text').innerText = `Total percentage is ${totalPercent.toFixed(1)}%. It must be 100%.`;
                    document.getElementById('alert-modal').classList.add('active');
                    return;
                }
                
                tempConsumers.forEach(c => {
                    const cost = (c.pct / 100) * amount;
                    consumers.push({ id: c.id, amount: cost, percent: c.pct });
                });
            } else if (currentSplitMethod === 'amount') { 
                const inputs = splitContainer.querySelectorAll('.split-input-val');
                let sumAmounts = 0;
                let tempConsumers = [];
                
                inputs.forEach(inp => {
                    const cost = parseFloat(inp.value) || 0;
                    if (cost > 0) {
                        sumAmounts += cost;
                        tempConsumers.push({ id: parseInt(inp.dataset.id), amount: cost });
                    }
                });
                
                if (Math.abs(sumAmounts) < 0.01) {
                    document.getElementById('alert-modal').querySelector('.modal-text').innerText = "Enter amounts for at least one person.";
                    document.getElementById('alert-modal').classList.add('active');
                    return;
                }
                
                if (Math.abs(sumAmounts - amount) > 0.02) {
                    document.getElementById('alert-modal').querySelector('.modal-text').innerText = `Total split amount (${appSettings.currency}${sumAmounts.toFixed(2)}) does not match expense amount (${appSettings.currency}${amount.toFixed(2)}).`;
                    document.getElementById('alert-modal').classList.add('active');
                    return;
                }
                
                consumers = tempConsumers;
            }

            // 3. Validation
            if (!desc || isNaN(amount) || amount <= 0) {
                document.getElementById('alert-modal').querySelector('.modal-text').innerText = "Please enter a valid description and amount.";
                document.getElementById('alert-modal').classList.add('active');
                return;
            }
            if (payers.length === 0) {
                document.getElementById('alert-modal').querySelector('.modal-text').innerText = "Payer information is missing.";
                document.getElementById('alert-modal').classList.add('active');
                return;
            }
            if (consumers.length === 0) {
                document.getElementById('alert-modal').querySelector('.modal-text').innerText = "Consumer information is missing or amounts are zero.";
                document.getElementById('alert-modal').classList.add('active');
                return;
            }

            if (payerValue === 'multiple') {
                const sumPayers = payers.reduce((acc, p) => acc + p.amount, 0);
                if (Math.abs(sumPayers - amount) > 0.02) {
                    document.getElementById('alert-modal').querySelector('.modal-text').innerText = `Total amount (${appSettings.currency}${amount.toFixed(2)}) does not match sum of payers (${appSettings.currency}${sumPayers.toFixed(2)}).`;
                    document.getElementById('alert-modal').classList.add('active');
                    return;
                }
            }

            // 4. Apply Logic 
            if (editingActivityId) {
                activities = activities.filter(a => a.id !== editingActivityId);
            }

            let payerNameDisplay = 'Unknown';
            if (payers.length > 1) {
                payerNameDisplay = 'Multiple people';
            } else {
                const p = friends.find(f => f.id == payers[0].id);
                payerNameDisplay = p ? p.name : 'Unknown';
            }

            const newActivity = {
                id: editingActivityId || Date.now(),
                groupId: groupId,
                desc: desc,
                amount: amount,
                date: dateVal,
                payers: payers,
                consumers: consumers,
                payerName: payerNameDisplay,
                splitMethod: currentSplitMethod,
                type: 'expense',
                category: category // Save category
            };

            activities.push(newActivity);
            activities.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            saveData();
            closeModal('expense-modal');
        });
        
        settleForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const payerId = parseInt(settlePayerSelect.value);
            const recipientId = parseInt(settleRecipientSelect.value);
            const amount = parseFloat(settleAmountInput.value);
            const dateVal = settleDateInput.value;
            
            if(payerId === recipientId) {
                document.getElementById('alert-modal').querySelector('.modal-text').innerText = "Payer and recipient cannot be the same person.";
                document.getElementById('alert-modal').classList.add('active');
                return;
            }
            
            if(isNaN(amount) || amount <= 0) {
                document.getElementById('alert-modal').querySelector('.modal-text').innerText = "Please enter a valid amount.";
                document.getElementById('alert-modal').classList.add('active');
                return;
            }
            
            const payer = friends.find(f => f.id === payerId);
            const recipient = friends.find(f => f.id === recipientId);
            
            if (!payer || !recipient || payer.groupId !== recipient.groupId) {
                 document.getElementById('alert-modal').querySelector('.modal-text').innerText = "Invalid transaction participants.";
                 document.getElementById('alert-modal').classList.add('active');
                 return;
            }

            const newActivity = {
                id: Date.now(),
                groupId: payer.groupId,
                desc: 'Settlement',
                amount: amount,
                date: dateVal,
                type: 'settlement',
                payerName: payer.name,
                recipientName: recipient.name,
                payerId: payerId,
                recipientId: recipientId
            };
            
            activities.push(newActivity);
            activities.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            saveData();
            closeModal('settle-modal');
        });

        friendForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const name = document.getElementById('friend-name-input').value;
            const groupId = parseInt(document.getElementById('group-select-assign').value);
            if (!name) return;
            const newFriend = {
                id: Date.now(),
                name: name,
                groupId: groupId,
                avatar: name, 
                balance: 0
            };
            friends.push(newFriend);
            saveData();
            closeModal('friend-modal');
        });

        groupForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const name = document.getElementById('group-name-input').value;
            if (!name) return;
            const newGroup = {
                id: Date.now(),
                name: name,
                archived: false
            };
            groups.push(newGroup);
            saveData();
            closeModal('group-modal');
        });
        // Initial render on page load
        render();
    </script>
</body>
</html>